name: Restore All Versions

on:
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œ

jobs:
  restore:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸš€ ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆï¼ˆã™ã¹ã¦ã®å±¥æ­´ã‚’å–å¾—ï¼‰
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ã™ã¹ã¦ã®ã‚³ãƒŸãƒƒãƒˆå±¥æ­´ã‚’å–å¾—

      - name: ðŸ” éŽåŽ»ã™ã¹ã¦ã®ã‚³ãƒŸãƒƒãƒˆæƒ…å ±ã‚’å–å¾—
        id: get_commits
        run: |
          # ã™ã¹ã¦ã®ã‚³ãƒŸãƒƒãƒˆIDã¨æ—¥ä»˜ã‚’å–å¾—
          git log --pretty=format:"%H %ad" --date=short > commits.txt
          echo "âœ… Found $(wc -l < commits.txt) commits"

      - name: ðŸ”„ å„ã‚³ãƒŸãƒƒãƒˆã‚’ãƒ–ãƒ©ãƒ³ãƒã¨ã—ã¦ä½œæˆ
        run: |
          while IFS=" " read -r commit_id commit_date; do
            branch_name="version-${commit_date}"
            folder_path="versions/${branch_name}"

            echo "â³ Processing $branch_name ($commit_id)..."

            # æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ
            git checkout -b "$branch_name" "$commit_id"

            # ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã€ç¾åœ¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç§»å‹•
            mkdir -p "$folder_path"
            find . -mindepth 1 -maxdepth 1 ! -name "versions" ! -name ".git" ! -name ".github" -exec mv {} "$folder_path/" \;

            # ã‚³ãƒŸãƒƒãƒˆï¼†ãƒ—ãƒƒã‚·ãƒ¥
            git add .
            git commit -m "Move $commit_date version into $folder_path"
            git push origin "$branch_name"

            echo "âœ… $branch_name pushed successfully!"
            
            # `main` ã«æˆ»ã‚‹
            git checkout main
          done < commits.txt

      - name: ðŸŽ‰ å®Œäº†
        run: echo "All versions processed!"
